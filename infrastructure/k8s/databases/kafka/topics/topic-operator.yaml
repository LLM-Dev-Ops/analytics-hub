---
# Strimzi Topic Operator for declarative topic management
apiVersion: v1
kind: ServiceAccount
metadata:
  name: strimzi-topic-operator
  namespace: kafka
  labels:
    app: strimzi

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: strimzi-topic-operator
  namespace: kafka
  labels:
    app: strimzi
rules:
- apiGroups:
  - kafka.strimzi.io
  resources:
  - kafkatopics
  - kafkatopics/status
  verbs:
  - get
  - list
  - watch
  - create
  - patch
  - update
  - delete
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: strimzi-topic-operator
  namespace: kafka
  labels:
    app: strimzi
subjects:
- kind: ServiceAccount
  name: strimzi-topic-operator
  namespace: kafka
roleRef:
  kind: Role
  name: strimzi-topic-operator
  apiGroup: rbac.authorization.k8s.io

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: strimzi-topic-operator
  namespace: kafka
  labels:
    app: strimzi
spec:
  replicas: 1
  selector:
    matchLabels:
      name: strimzi-topic-operator
  template:
    metadata:
      labels:
        name: strimzi-topic-operator
    spec:
      serviceAccountName: strimzi-topic-operator
      containers:
      - name: strimzi-topic-operator
        image: quay.io/strimzi/operator:0.38.0
        args:
        - /opt/strimzi/bin/topic_operator_run.sh
        env:
        - name: STRIMZI_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: STRIMZI_KAFKA_BOOTSTRAP_SERVERS
          value: kafka:9092
        - name: STRIMZI_RESOURCE_LABELS
          value: "strimzi.io/cluster=kafka"
        - name: STRIMZI_FULL_RECONCILIATION_INTERVAL_MS
          value: "120000"
        - name: STRIMZI_LOG_LEVEL
          value: INFO
        - name: STRIMZI_TLS_ENABLED
          value: "false"
        - name: STRIMZI_JAVA_OPTS
          value: "-Xmx256M -Xms128M"
        - name: STRIMZI_JAVA_SYSTEM_PROPERTIES
          value: "-Djavax.net.debug=ssl"
        livenessProbe:
          httpGet:
            path: /healthy
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 30
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

---
# Custom Resource Definition for KafkaTopic
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: kafkatopics.kafka.strimzi.io
  labels:
    app: strimzi
spec:
  group: kafka.strimzi.io
  names:
    kind: KafkaTopic
    listKind: KafkaTopicList
    singular: kafkatopic
    plural: kafkatopics
    shortNames:
    - kt
    categories:
    - strimzi
  scope: Namespaced
  versions:
  - name: v1beta2
    served: true
    storage: true
    subresources:
      status: {}
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              partitions:
                type: integer
                minimum: 1
              replicas:
                type: integer
                minimum: 1
                maximum: 32767
              config:
                type: object
                x-kubernetes-preserve-unknown-fields: true
              topicName:
                type: string
            required:
            - partitions
            - replicas
          status:
            type: object
            properties:
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                    lastTransitionTime:
                      type: string
                    reason:
                      type: string
                    message:
                      type: string
              observedGeneration:
                type: integer

---
# Example KafkaTopic custom resources
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: llm-events
  namespace: kafka
  labels:
    strimzi.io/cluster: kafka
spec:
  partitions: 32
  replicas: 3
  config:
    cleanup.policy: delete
    retention.ms: 604800000
    retention.bytes: 536870912000
    segment.ms: 86400000
    segment.bytes: 1073741824
    compression.type: lz4
    min.insync.replicas: 2
    max.message.bytes: 10485760

---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: llm-metrics
  namespace: kafka
  labels:
    strimzi.io/cluster: kafka
spec:
  partitions: 32
  replicas: 3
  config:
    cleanup.policy: delete
    retention.ms: 2592000000
    retention.bytes: 1073741824000
    segment.ms: 86400000
    segment.bytes: 1073741824
    compression.type: lz4
    min.insync.replicas: 2

---
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaTopic
metadata:
  name: llm-analytics
  namespace: kafka
  labels:
    strimzi.io/cluster: kafka
spec:
  partitions: 16
  replicas: 3
  config:
    cleanup.policy: delete
    retention.ms: 604800000
    compression.type: lz4
    min.insync.replicas: 2
