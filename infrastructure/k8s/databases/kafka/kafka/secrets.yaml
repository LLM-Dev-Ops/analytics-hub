---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-secrets
  namespace: kafka
  labels:
    app: kafka
    component: messaging
type: Opaque
stringData:
  # SASL/SCRAM credentials (base64 encoded in production)
  admin-password: "changeme-admin-password-prod"
  user-password: "changeme-user-password-prod"

  # Zookeeper credentials
  zk-kafka-password: "changeme-zk-kafka-password"

  # SSL keystore passwords
  ssl-keystore-password: "changeme-keystore-password"
  ssl-key-password: "changeme-key-password"
  ssl-truststore-password: "changeme-truststore-password"

---
apiVersion: v1
kind: Secret
metadata:
  name: kafka-jks-secrets
  namespace: kafka
  labels:
    app: kafka
    component: messaging
type: Opaque
data:
  # Generate these with:
  # keytool -genkey -keystore kafka.server.keystore.jks -validity 365 -storepass changeme -keypass changeme -dname "CN=kafka" -storetype pkcs12
  # Then base64 encode: cat kafka.server.keystore.jks | base64 -w 0
  kafka.server.keystore.jks: ""
  kafka.server.truststore.jks: ""

---
# Secret for TLS certificates (cert-manager integration)
apiVersion: v1
kind: Secret
metadata:
  name: kafka-tls
  namespace: kafka
  labels:
    app: kafka
    component: messaging
type: kubernetes.io/tls
data:
  # Generated by cert-manager or manually created
  # openssl req -x509 -newkey rsa:4096 -keyout tls.key -out tls.crt -days 365 -nodes -subj "/CN=kafka.kafka.svc.cluster.local"
  tls.crt: ""
  tls.key: ""

---
# ConfigMap for creating SASL users
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-users
  namespace: kafka
  labels:
    app: kafka
    component: messaging
data:
  create-users.sh: |
    #!/bin/bash
    set -e

    echo "Creating SASL/SCRAM users..."

    # Wait for Kafka to be ready
    while ! kafka-broker-api-versions.sh --bootstrap-server localhost:9092 > /dev/null 2>&1; do
      echo "Waiting for Kafka to be ready..."
      sleep 5
    done

    # Create admin user
    kafka-configs.sh --zookeeper zookeeper:2181 \
      --alter \
      --add-config 'SCRAM-SHA-512=[password='${KAFKA_ADMIN_PASSWORD}']' \
      --entity-type users \
      --entity-name admin

    # Create application users
    kafka-configs.sh --zookeeper zookeeper:2181 \
      --alter \
      --add-config 'SCRAM-SHA-512=[password='${KAFKA_USER_PASSWORD}']' \
      --entity-type users \
      --entity-name llm-analytics-producer

    kafka-configs.sh --zookeeper zookeeper:2181 \
      --alter \
      --add-config 'SCRAM-SHA-512=[password='${KAFKA_USER_PASSWORD}']' \
      --entity-type users \
      --entity-name llm-analytics-consumer

    echo "Users created successfully"

  delete-users.sh: |
    #!/bin/bash
    set -e

    echo "Deleting SASL/SCRAM users..."

    kafka-configs.sh --zookeeper zookeeper:2181 \
      --alter \
      --delete-config 'SCRAM-SHA-512' \
      --entity-type users \
      --entity-name admin

    kafka-configs.sh --zookeeper zookeeper:2181 \
      --alter \
      --delete-config 'SCRAM-SHA-512' \
      --entity-type users \
      --entity-name llm-analytics-producer

    kafka-configs.sh --zookeeper zookeeper:2181 \
      --alter \
      --delete-config 'SCRAM-SHA-512' \
      --entity-type users \
      --entity-name llm-analytics-consumer

    echo "Users deleted successfully"
