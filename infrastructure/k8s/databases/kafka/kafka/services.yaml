---
apiVersion: v1
kind: Service
metadata:
  name: kafka-headless
  namespace: kafka
  labels:
    app: kafka
    component: messaging
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
  - port: 9092
    targetPort: 9092
    protocol: TCP
    name: internal
  - port: 9094
    targetPort: 9094
    protocol: TCP
    name: external
  selector:
    app: kafka

---
apiVersion: v1
kind: Service
metadata:
  name: kafka
  namespace: kafka
  labels:
    app: kafka
    component: messaging
spec:
  type: ClusterIP
  ports:
  - port: 9092
    targetPort: 9092
    protocol: TCP
    name: internal
  selector:
    app: kafka

---
apiVersion: v1
kind: Service
metadata:
  name: kafka-external
  namespace: kafka
  labels:
    app: kafka
    component: messaging
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-internal: "true"
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  ports:
  - port: 9094
    targetPort: 9094
    protocol: TCP
    name: external
  selector:
    app: kafka

---
apiVersion: v1
kind: Service
metadata:
  name: kafka-metrics
  namespace: kafka
  labels:
    app: kafka
    component: messaging
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "7071"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
  - port: 7071
    targetPort: 7071
    protocol: TCP
    name: metrics
  - port: 9999
    targetPort: 9999
    protocol: TCP
    name: jmx
  selector:
    app: kafka

---
# Per-broker external services for direct access
apiVersion: v1
kind: Service
metadata:
  name: kafka-0-external
  namespace: kafka
  labels:
    app: kafka
    component: messaging
    statefulset.kubernetes.io/pod-name: kafka-0
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  ports:
  - port: 9094
    targetPort: 9094
    protocol: TCP
    name: external
  selector:
    app: kafka
    statefulset.kubernetes.io/pod-name: kafka-0

---
apiVersion: v1
kind: Service
metadata:
  name: kafka-1-external
  namespace: kafka
  labels:
    app: kafka
    component: messaging
    statefulset.kubernetes.io/pod-name: kafka-1
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  ports:
  - port: 9094
    targetPort: 9094
    protocol: TCP
    name: external
  selector:
    app: kafka
    statefulset.kubernetes.io/pod-name: kafka-1

---
apiVersion: v1
kind: Service
metadata:
  name: kafka-2-external
  namespace: kafka
  labels:
    app: kafka
    component: messaging
    statefulset.kubernetes.io/pod-name: kafka-2
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  ports:
  - port: 9094
    targetPort: 9094
    protocol: TCP
    name: external
  selector:
    app: kafka
    statefulset.kubernetes.io/pod-name: kafka-2
