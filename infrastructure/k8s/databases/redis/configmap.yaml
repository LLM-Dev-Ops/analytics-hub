---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
  namespace: redis-system
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: config
data:
  redis.conf: |
    # Redis Cluster Configuration for LLM Analytics Hub
    # Redis 7.2+ Production Configuration

    # Cluster Configuration
    cluster-enabled yes
    cluster-config-file /data/nodes.conf
    cluster-node-timeout 15000
    cluster-replica-validity-factor 10
    cluster-migration-barrier 1
    cluster-require-full-coverage no
    cluster-replica-no-failover no
    cluster-allow-reads-when-down no

    # Network Configuration
    bind 0.0.0.0
    port 6379
    tcp-backlog 511
    timeout 300
    tcp-keepalive 300

    # TLS/SSL Configuration (uncomment when TLS is enabled)
    # tls-port 6380
    # port 0
    # tls-cert-file /etc/redis/tls/tls.crt
    # tls-key-file /etc/redis/tls/tls.key
    # tls-ca-cert-file /etc/redis/tls/ca.crt
    # tls-auth-clients no
    # tls-replication yes
    # tls-cluster yes

    # General Configuration
    daemonize no
    supervised no
    pidfile /var/run/redis.pid
    loglevel notice
    logfile ""
    databases 16
    always-show-logo no

    # Security
    protected-mode yes
    requirepass REDIS_PASSWORD
    masterauth REDIS_PASSWORD

    # Memory Management
    maxmemory 6gb
    maxmemory-policy allkeys-lru
    maxmemory-samples 5

    # Lazy Freeing
    lazyfree-lazy-eviction yes
    lazyfree-lazy-expire yes
    lazyfree-lazy-server-del yes
    replica-lazy-flush yes
    lazyfree-lazy-user-del yes

    # AOF Persistence
    appendonly yes
    appendfilename "appendonly.aof"
    appenddirname "appendonlydir"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb
    aof-load-truncated yes
    aof-use-rdb-preamble yes
    aof-timestamp-enabled yes

    # RDB Persistence
    save 900 1
    save 300 10
    save 60 10000
    stop-writes-on-bgsave-error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data

    # Replication
    repl-diskless-sync yes
    repl-diskless-sync-delay 5
    repl-diskless-sync-max-replicas 0
    repl-diskless-load on-empty-db
    repl-disable-tcp-nodelay no
    repl-backlog-size 256mb
    repl-backlog-ttl 3600
    replica-priority 100

    # Performance Optimization
    slowlog-log-slower-than 10000
    slowlog-max-len 128
    latency-monitor-threshold 100

    # Client Configuration
    maxclients 10000

    # Memory Defragmentation
    activedefrag yes
    active-defrag-ignore-bytes 100mb
    active-defrag-threshold-lower 10
    active-defrag-threshold-upper 25
    active-defrag-cycle-min 5
    active-defrag-cycle-max 75

    # Kernel Optimization
    # Set via init container: echo never > /sys/kernel/mm/transparent_hugepage/enabled

    # Event Notification
    notify-keyspace-events ""

    # Advanced Configuration
    hash-max-listpack-entries 512
    hash-max-listpack-value 64
    list-max-listpack-size -2
    list-compress-depth 0
    set-max-intset-entries 512
    zset-max-listpack-entries 128
    zset-max-listpack-value 64
    hll-sparse-max-bytes 3000
    stream-node-max-bytes 4096
    stream-node-max-entries 100

    # IO Threads (Redis 6+)
    io-threads 4
    io-threads-do-reads yes

    # Monitoring
    latency-tracking yes
    latency-tracking-info-percentiles 50 99 99.9

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-scripts
  namespace: redis-system
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: scripts
data:
  readiness.sh: |
    #!/bin/bash
    set -e

    # Check if Redis is responding
    if [ -n "$REDIS_PASSWORD" ]; then
      response=$(redis-cli -a "$REDIS_PASSWORD" ping 2>/dev/null)
    else
      response=$(redis-cli ping 2>/dev/null)
    fi

    if [ "$response" != "PONG" ]; then
      echo "Redis not responding"
      exit 1
    fi

    # Check cluster state if in cluster mode
    if [ -n "$REDIS_PASSWORD" ]; then
      cluster_state=$(redis-cli -a "$REDIS_PASSWORD" cluster info 2>/dev/null | grep cluster_state | cut -d: -f2)
    else
      cluster_state=$(redis-cli cluster info 2>/dev/null | grep cluster_state | cut -d: -f2)
    fi

    if [ "$cluster_state" != "ok" ]; then
      echo "Cluster state: $cluster_state"
      exit 1
    fi

    echo "Redis is ready"
    exit 0

  liveness.sh: |
    #!/bin/bash
    set -e

    # Simple ping check
    if [ -n "$REDIS_PASSWORD" ]; then
      response=$(redis-cli -a "$REDIS_PASSWORD" ping 2>/dev/null)
    else
      response=$(redis-cli ping 2>/dev/null)
    fi

    if [ "$response" = "PONG" ]; then
      exit 0
    else
      exit 1
    fi

  backup.sh: |
    #!/bin/bash
    set -e

    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="redis-backup-${HOSTNAME}-${TIMESTAMP}.rdb"

    echo "Starting Redis backup at $(date)"

    # Trigger BGSAVE
    if [ -n "$REDIS_PASSWORD" ]; then
      redis-cli -a "$REDIS_PASSWORD" BGSAVE
    else
      redis-cli BGSAVE
    fi

    # Wait for BGSAVE to complete
    while true; do
      if [ -n "$REDIS_PASSWORD" ]; then
        LASTSAVE=$(redis-cli -a "$REDIS_PASSWORD" LASTSAVE)
      else
        LASTSAVE=$(redis-cli LASTSAVE)
      fi

      sleep 5

      if [ -n "$REDIS_PASSWORD" ]; then
        NEWSAVE=$(redis-cli -a "$REDIS_PASSWORD" LASTSAVE)
      else
        NEWSAVE=$(redis-cli LASTSAVE)
      fi

      if [ "$NEWSAVE" != "$LASTSAVE" ]; then
        echo "BGSAVE completed"
        break
      fi

      echo "Waiting for BGSAVE to complete..."
    done

    # Copy dump.rdb to backup location
    cp /data/dump.rdb "/backup/${BACKUP_FILE}"

    # Upload to S3 if configured
    if [ -n "$S3_BUCKET" ]; then
      aws s3 cp "/backup/${BACKUP_FILE}" "s3://${S3_BUCKET}/${S3_PREFIX}${BACKUP_FILE}"
      echo "Backup uploaded to S3: s3://${S3_BUCKET}/${S3_PREFIX}${BACKUP_FILE}"
    fi

    # Cleanup old backups (keep last 7 days)
    find /backup -name "redis-backup-*.rdb" -mtime +7 -delete

    echo "Backup completed at $(date)"
