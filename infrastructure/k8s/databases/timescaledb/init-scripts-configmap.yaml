---
apiVersion: v1
kind: ConfigMap
metadata:
  name: timescaledb-init-scripts
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: initialization
data:
  01-init-database.sql: |
    -- TimescaleDB Initialization Script
    -- This script sets up the initial database structure for LLM Analytics Hub

    -- Enable required extensions
    CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
    CREATE EXTENSION IF NOT EXISTS pgcrypto;
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    -- Create application database
    CREATE DATABASE llm_analytics
        WITH
        ENCODING = 'UTF8'
        LC_COLLATE = 'en_US.UTF-8'
        LC_CTYPE = 'en_US.UTF-8'
        TEMPLATE = template0;

    -- Connect to the application database
    \c llm_analytics

    -- Enable extensions in application database
    CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
    CREATE EXTENSION IF NOT EXISTS pgcrypto;
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    -- Create roles
    CREATE ROLE llm_app_readonly;
    CREATE ROLE llm_app_readwrite;
    CREATE ROLE llm_app WITH LOGIN PASSWORD :'APP_PASSWORD';

    -- Grant role memberships
    GRANT llm_app_readonly TO llm_app;
    GRANT llm_app_readwrite TO llm_app;

    -- Create schemas
    CREATE SCHEMA IF NOT EXISTS analytics AUTHORIZATION llm_app;
    CREATE SCHEMA IF NOT EXISTS metrics AUTHORIZATION llm_app;
    CREATE SCHEMA IF NOT EXISTS events AUTHORIZATION llm_app;
    CREATE SCHEMA IF NOT EXISTS aggregates AUTHORIZATION llm_app;

    -- Set search path
    ALTER DATABASE llm_analytics SET search_path TO analytics, metrics, events, aggregates, public;

    -- Grant schema permissions
    GRANT USAGE ON SCHEMA analytics TO llm_app_readonly;
    GRANT USAGE ON SCHEMA metrics TO llm_app_readonly;
    GRANT USAGE ON SCHEMA events TO llm_app_readonly;
    GRANT USAGE ON SCHEMA aggregates TO llm_app_readonly;

    GRANT USAGE, CREATE ON SCHEMA analytics TO llm_app_readwrite;
    GRANT USAGE, CREATE ON SCHEMA metrics TO llm_app_readwrite;
    GRANT USAGE, CREATE ON SCHEMA events TO llm_app_readwrite;
    GRANT USAGE, CREATE ON SCHEMA aggregates TO llm_app_readwrite;

    -- Set default privileges
    ALTER DEFAULT PRIVILEGES IN SCHEMA analytics GRANT SELECT ON TABLES TO llm_app_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA metrics GRANT SELECT ON TABLES TO llm_app_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA events GRANT SELECT ON TABLES TO llm_app_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA aggregates GRANT SELECT ON TABLES TO llm_app_readonly;

    ALTER DEFAULT PRIVILEGES IN SCHEMA analytics GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO llm_app_readwrite;
    ALTER DEFAULT PRIVILEGES IN SCHEMA metrics GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO llm_app_readwrite;
    ALTER DEFAULT PRIVILEGES IN SCHEMA events GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO llm_app_readwrite;
    ALTER DEFAULT PRIVILEGES IN SCHEMA aggregates GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO llm_app_readwrite;

    ALTER DEFAULT PRIVILEGES IN SCHEMA analytics GRANT USAGE, SELECT ON SEQUENCES TO llm_app_readwrite;
    ALTER DEFAULT PRIVILEGES IN SCHEMA metrics GRANT USAGE, SELECT ON SEQUENCES TO llm_app_readwrite;
    ALTER DEFAULT PRIVILEGES IN SCHEMA events GRANT USAGE, SELECT ON SEQUENCES TO llm_app_readwrite;
    ALTER DEFAULT PRIVILEGES IN SCHEMA aggregates GRANT USAGE, SELECT ON SEQUENCES TO llm_app_readwrite;

    -- Create metadata table
    CREATE TABLE IF NOT EXISTS analytics.metadata (
        key TEXT PRIMARY KEY,
        value JSONB NOT NULL,
        created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
    );

    -- Insert initial metadata
    INSERT INTO analytics.metadata (key, value) VALUES
        ('schema_version', '"1.0.0"'::jsonb),
        ('initialized_at', to_jsonb(CURRENT_TIMESTAMP)),
        ('timescaledb_version', to_jsonb(extversion) FROM pg_extension WHERE extname = 'timescaledb')
    ON CONFLICT (key) DO NOTHING;
