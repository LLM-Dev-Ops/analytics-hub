---
apiVersion: v1
kind: ConfigMap
metadata:
  name: timescaledb-config
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
data:
  # PostgreSQL Configuration optimized for TimescaleDB and time-series workloads
  postgresql.conf: |
    # Connection Settings
    listen_addresses = '*'
    port = 5432
    max_connections = 200
    superuser_reserved_connections = 3

    # Memory Settings (optimized for 32GB RAM)
    shared_buffers = 8GB
    effective_cache_size = 24GB
    maintenance_work_mem = 2GB
    work_mem = 64MB
    huge_pages = try

    # WAL Settings (Write-Ahead Logging)
    wal_level = replica
    wal_log_hints = on
    wal_buffers = 16MB
    min_wal_size = 2GB
    max_wal_size = 8GB
    wal_compression = on
    wal_keep_size = 1GB

    # Replication Settings
    max_wal_senders = 10
    max_replication_slots = 10
    hot_standby = on
    hot_standby_feedback = on
    wal_receiver_timeout = 60s
    wal_sender_timeout = 60s

    # Checkpointing
    checkpoint_timeout = 15min
    checkpoint_completion_target = 0.9
    checkpoint_warning = 30s

    # Archiving
    archive_mode = on
    archive_command = '/usr/local/bin/archive_command.sh %p %f'
    archive_timeout = 300

    # Query Planning
    random_page_cost = 1.1  # SSD optimized
    effective_io_concurrency = 200  # SSD optimized
    default_statistics_target = 100

    # Logging
    logging_collector = on
    log_destination = 'stderr'
    log_directory = '/var/log/postgresql'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
    log_checkpoints = on
    log_connections = on
    log_disconnections = on
    log_duration = off
    log_lock_waits = on
    log_statement = 'ddl'
    log_temp_files = 0
    log_autovacuum_min_duration = 0
    log_error_verbosity = default
    log_min_duration_statement = 1000

    # Autovacuum (aggressive for time-series)
    autovacuum = on
    autovacuum_max_workers = 4
    autovacuum_naptime = 10s
    autovacuum_vacuum_threshold = 50
    autovacuum_analyze_threshold = 50
    autovacuum_vacuum_scale_factor = 0.05
    autovacuum_analyze_scale_factor = 0.02
    autovacuum_vacuum_cost_delay = 2ms
    autovacuum_vacuum_cost_limit = 1000

    # Background Writer
    bgwriter_delay = 200ms
    bgwriter_lru_maxpages = 100
    bgwriter_lru_multiplier = 2.0

    # Security
    ssl = on
    ssl_cert_file = '/etc/postgresql/tls/tls.crt'
    ssl_key_file = '/etc/postgresql/tls/tls.key'
    ssl_prefer_server_ciphers = on
    ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'
    password_encryption = scram-sha-256

    # TimescaleDB Specific
    shared_preload_libraries = 'timescaledb,pg_stat_statements'
    timescaledb.telemetry_level = off
    timescaledb.max_background_workers = 8

    # Performance
    track_activities = on
    track_counts = on
    track_io_timing = on
    track_functions = all

    # Statement Statistics
    pg_stat_statements.track = all
    pg_stat_statements.max = 10000

    # Parallel Query
    max_worker_processes = 8
    max_parallel_workers_per_gather = 4
    max_parallel_workers = 8
    max_parallel_maintenance_workers = 4

  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD

    # Local connections
    local   all             postgres                                peer
    local   all             all                                     scram-sha-256

    # Replication connections
    host    replication     replicator      0.0.0.0/0               scram-sha-256
    host    replication     replicator      ::0/0                   scram-sha-256

    # Application connections (require SSL)
    hostssl all             all             0.0.0.0/0               scram-sha-256
    hostssl all             all             ::0/0                   scram-sha-256

    # Patroni connections
    host    all             postgres        127.0.0.1/32            scram-sha-256
    host    all             postgres        ::1/128                 scram-sha-256

  # TimescaleDB initialization and policies
  timescaledb-init.sql: |
    -- Enable TimescaleDB extension
    CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

    -- Create application database
    CREATE DATABASE llm_analytics;

    -- Connect to application database
    \c llm_analytics

    -- Enable extensions in application database
    CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
    CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

    -- Create application user
    CREATE ROLE llm_app WITH LOGIN PASSWORD :'APP_PASSWORD';
    GRANT CONNECT ON DATABASE llm_analytics TO llm_app;

    -- Create schemas
    CREATE SCHEMA IF NOT EXISTS analytics AUTHORIZATION llm_app;
    CREATE SCHEMA IF NOT EXISTS metrics AUTHORIZATION llm_app;
    CREATE SCHEMA IF NOT EXISTS events AUTHORIZATION llm_app;

    -- Grant permissions
    GRANT USAGE ON SCHEMA analytics TO llm_app;
    GRANT USAGE ON SCHEMA metrics TO llm_app;
    GRANT USAGE ON SCHEMA events TO llm_app;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA analytics TO llm_app;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA metrics TO llm_app;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA events TO llm_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA analytics GRANT ALL ON TABLES TO llm_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA metrics GRANT ALL ON TABLES TO llm_app;
    ALTER DEFAULT PRIVILEGES IN SCHEMA events GRANT ALL ON TABLES TO llm_app;

  # Archive command script
  archive_command.sh: |
    #!/bin/bash
    # Archive WAL files to backup location
    # $1 = %p (file path)
    # $2 = %f (file name)

    set -e

    WAL_PATH="$1"
    WAL_FILE="$2"
    ARCHIVE_DIR="/backup/wal_archive"

    # Create archive directory if it doesn't exist
    mkdir -p "$ARCHIVE_DIR"

    # Copy WAL file to archive
    cp "$WAL_PATH" "$ARCHIVE_DIR/$WAL_FILE"

    # Optionally upload to S3
    if [ -n "$S3_BUCKET" ]; then
        aws s3 cp "$WAL_PATH" "s3://$S3_BUCKET/wal_archive/$WAL_FILE"
    fi

    exit 0
