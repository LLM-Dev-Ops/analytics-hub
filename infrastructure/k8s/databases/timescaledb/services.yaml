---
# Headless Service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: timescaledb-headless
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    service-type: headless
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
    protocol: TCP
  - name: patroni
    port: 8008
    targetPort: 8008
    protocol: TCP
  selector:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database

---
# Read-Write Service (Primary Only)
apiVersion: v1
kind: Service
metadata:
  name: timescaledb-rw
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    service-type: read-write
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-internal: "true"
spec:
  type: ClusterIP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
    protocol: TCP
  selector:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    role: master  # Patroni sets this label on the primary

---
# Read-Only Service (Replicas Only)
apiVersion: v1
kind: Service
metadata:
  name: timescaledb-ro
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    service-type: read-only
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-internal: "true"
spec:
  type: ClusterIP
  sessionAffinity: None
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
    protocol: TCP
  selector:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    role: replica  # Patroni sets this label on replicas

---
# Load Balanced Service (All Instances)
apiVersion: v1
kind: Service
metadata:
  name: timescaledb
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    service-type: load-balanced
spec:
  type: ClusterIP
  sessionAffinity: None
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
    protocol: TCP
  - name: patroni
    port: 8008
    targetPort: 8008
    protocol: TCP
  - name: metrics
    port: 9187
    targetPort: 9187
    protocol: TCP
  selector:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database

---
# External Load Balancer (Optional - for external access)
apiVersion: v1
kind: Service
metadata:
  name: timescaledb-external
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    service-type: external
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-internal: "false"
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    # Restrict source IPs for security
    service.beta.kubernetes.io/load-balancer-source-ranges: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  ports:
  - name: postgresql
    port: 5432
    targetPort: 5432
    protocol: TCP
  selector:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    role: master

---
# Metrics Service for Prometheus
apiVersion: v1
kind: Service
metadata:
  name: timescaledb-metrics
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: metrics
spec:
  type: ClusterIP
  ports:
  - name: metrics
    port: 9187
    targetPort: 9187
    protocol: TCP
  selector:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database

---
# Endpoint for connection details
apiVersion: v1
kind: Endpoints
metadata:
  name: timescaledb-connection-info
  namespace: timescaledb
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
  annotations:
    connection-string-rw: "postgresql://llm_app:APP_PASSWORD@timescaledb-rw.timescaledb.svc.cluster.local:5432/llm_analytics?sslmode=require"
    connection-string-ro: "postgresql://llm_app:APP_PASSWORD@timescaledb-ro.timescaledb.svc.cluster.local:5432/llm_analytics?sslmode=require"
    connection-string-pooled: "postgresql://llm_app:APP_PASSWORD@pgbouncer.timescaledb.svc.cluster.local:6432/llm_analytics"
    jdbc-url-rw: "jdbc:postgresql://timescaledb-rw.timescaledb.svc.cluster.local:5432/llm_analytics?ssl=true&sslmode=require"
    jdbc-url-ro: "jdbc:postgresql://timescaledb-ro.timescaledb.svc.cluster.local:5432/llm_analytics?ssl=true&sslmode=require"
