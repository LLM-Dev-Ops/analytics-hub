name: CD - Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["CD - Build and Push Images"]
    types:
      - completed
    branches: [ main ]

env:
  KUBECTL_VERSION: 'v1.28.0'

jobs:
  # ====================
  # Deploy to Staging
  # ====================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: staging
      url: https://staging.llm-analytics.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: ${{ env.KUBECTL_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name llm-analytics-staging --region us-east-1

    - name: Deploy to staging
      run: |
        kubectl apply -f k8s/applications/namespace.yaml
        kubectl apply -f k8s/applications/event-ingestion/
        kubectl apply -f k8s/applications/api/
        kubectl apply -f k8s/applications/frontend/
        kubectl apply -f k8s/applications/ingress.yaml

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/event-ingestion -n llm-analytics --timeout=5m
        kubectl rollout status deployment/api -n llm-analytics --timeout=5m
        kubectl rollout status deployment/frontend -n llm-analytics --timeout=5m

    - name: Run smoke tests
      run: |
        curl -f https://staging-api.llm-analytics.com/health || exit 1
        curl -f https://staging.llm-analytics.com/health || exit 1

    - name: Notify deployment
      if: always()
      uses: slackapi/slack-github-action@v1
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "Deployment to Staging: ${{ job.status }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deployment to Staging*\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}"
                }
              }
            ]
          }

  # ====================
  # Deploy to Production
  # ====================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment:
      name: production
      url: https://llm-analytics.com

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: ${{ env.KUBECTL_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_PROD_ROLE_ARN }}
        aws-region: us-east-1

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name llm-analytics-prod --region us-east-1

    - name: Backup current deployment
      run: |
        mkdir -p backups
        kubectl get all -n llm-analytics -o yaml > backups/pre-deploy-$(date +%Y%m%d-%H%M%S).yaml

    - name: Deploy to production (blue-green)
      run: |
        # Update image tags to latest
        kubectl set image deployment/event-ingestion event-ingestion=ghcr.io/llm-analytics/event-ingestion:${{ github.sha }} -n llm-analytics
        kubectl set image deployment/api api=ghcr.io/llm-analytics/api:${{ github.sha }} -n llm-analytics
        kubectl set image deployment/frontend frontend=ghcr.io/llm-analytics/frontend:${{ github.sha }} -n llm-analytics

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/event-ingestion -n llm-analytics --timeout=10m
        kubectl rollout status deployment/api -n llm-analytics --timeout=10m
        kubectl rollout status deployment/frontend -n llm-analytics --timeout=10m

    - name: Run production smoke tests
      run: |
        curl -f https://api.llm-analytics.com/health || exit 1
        curl -f https://app.llm-analytics.com/health || exit 1
        curl -f https://ingest.llm-analytics.com/health || exit 1

    - name: Monitor for 5 minutes
      run: |
        echo "Monitoring deployment for 5 minutes..."
        for i in {1..30}; do
          kubectl get pods -n llm-analytics
          sleep 10
        done

    - name: Rollback on failure
      if: failure()
      run: |
        echo "Deployment failed, rolling back..."
        kubectl rollout undo deployment/event-ingestion -n llm-analytics
        kubectl rollout undo deployment/api -n llm-analytics
        kubectl rollout undo deployment/frontend -n llm-analytics

    - name: Notify deployment
      if: always()
      uses: slackapi/slack-github-action@v1
      with:
        webhook-url: ${{ secrets.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "Deployment to Production: ${{ job.status }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deployment to Production*\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref_name }}\nDeployed by: ${{ github.actor }}"
                }
              }
            ]
          }
